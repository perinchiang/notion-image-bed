name: Compress Images
on:
  push:
    paths:
      - 'images/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  compress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 1. å®‰è£…æ›´å¼ºçš„å·¥å…·: pngquant (å‹PNGç¥å™¨) å’Œ imagemagick (ç¼©æ”¾ç¥å™¨)
      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y jpegoptim pngquant imagemagick

      # 2. æ‰§è¡Œå‹ç¼©
      - name: Compress Images
        run: |
          echo "ğŸš€ Starting compression..."
          
          # --- æ­¥éª¤ A: å…ˆæŠŠè¶…å¤§çš„å›¾ç‰‡ç¼©å° (é™åˆ¶æœ€å¤§å®½åº¦ 2560px) ---
          # è¿™ä¸€æ­¥èƒ½ç¬é—´æŠŠ 27MB çš„å›¾å˜å°å¾ˆå¤šï¼Œé˜²æ­¢åé¢å¡æ­»
          # åªå¤„ç†å®½åº¦å¤§äº 2560 çš„å›¾ï¼Œå°çš„å›¾ä¸åŠ¨
          find images -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' | xargs -r mogrify -resize '2560>' 

          # --- æ­¥éª¤ B: æœ‰æŸå‹ç¼© JPG (è´¨é‡ 80%) ---
          find images -name '*.jpg' -o -name '*.jpeg' | xargs -r jpegoptim -m80 --strip-all

          # --- æ­¥éª¤ C: æœ‰æŸå‹ç¼© PNG (è´¨é‡ 60-80%, é€Ÿåº¦é£å¿«) ---
          # --force: å¼ºåˆ¶è¦†ç›–
          # --ext .png: ä¿æŒåç¼€ä¸å˜
          # --skip-if-larger: å¦‚æœå‹å®Œåè€Œå˜å¤§(æå°‘è§)å°±è·³è¿‡
          find images -name '*.png' | xargs -r pngquant --quality=60-80 --ext .png --force --skip-if-larger

      # 3. æäº¤æ›´æ”¹
      - name: Commit & Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          if [[ -n $(git status -s) ]]; then
            git add images/*
            git commit -m "ğŸ“‰ Auto Compress (Resize+Pngquant) [skip ci]"
            git push
            echo "âœ… Images compressed and pushed."
          else
            echo "âœ¨ No images needed compression."
          fi
